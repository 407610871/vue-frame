<template>
<div v-loading="loading">
    <div class="searchDiv">
        <div class="dataSearch">
            <i class="el-icon-search"></i>
            <input type="text" v-model="taskName" placeholder="请输入任务名称" />
        </div>
        <span  @click="doMoreSearch" >高级搜索 <i :class="!moreSearch?'el-icon-caret-bottom':'el-icon-caret-top'"></i>  </span>
        <el-button type="primary" class="doCearch" @click="search">查询</el-button> 
    </div>
    <el-form ref="form"  label-width="110px" class="formGroup" v-if="moreSearch">
        <el-form-item label="任务状态:">
            <el-checkbox :indeterminate="isIndeterminate" v-model="checkAll" @change="handleCheckAllChange">全选</el-checkbox>
            <el-checkbox-group v-model="status" @change="handleCheckedCitiesChange">
                <el-checkbox name="status" v-for="(index,item) in checkStatus" :label="item.label" :key="index">{{item.name}}</el-checkbox>
            </el-checkbox-group>
        </el-form-item>
        <el-form-item label="任务开始时间:">  
            <el-date-picker
            v-model="time"
            :picker-options="pickerOptions"
            type="datetimerange"
            start-placeholder="开始时间"
            end-placeholder="结束时间"
            value-format="yyyy-MM-dd HH:MM:ss"
            :default-time="['12:00:00']">
            </el-date-picker>
        </el-form-item>
    </el-form>
    <el-table :data="tableData" :height="tableHeight">
        <el-table-column label="序号" type="index" width="100"></el-table-column>
        <el-table-column label="任务名称" prop="taskName"></el-table-column>
        <el-table-column label="任务类型"  prop="taskType"></el-table-column>
        <el-table-column label="任务开始时间">
            <template slot-scope="scope">
                <span>{{scope.row.startTime | formatDateTime}}</span>
            </template>
        </el-table-column>
        <el-table-column label="任务停止时间">
            <template slot-scope="scope">
                <span>{{scope.row.endTime | formatDateTime}}</span>
            </template>
        </el-table-column>
        <el-table-column label="任务状态">
            <template slot-scope="scope">
                <span v-if="scope.row.status == 'create'">新建</span>
                <span v-if="scope.row.status == 'Running'">运行</span>
                <span v-if="scope.row.status == 'Paused'">暂停</span>
                <span v-if="scope.row.status == 'Finished (with errors)'" class="finished-fail">失败</span>
                <span v-if="scope.row.status == 'Finished'">完成</span>
            </template>
        </el-table-column>
        <el-table-column label="操作">
            <template slot-scope="scope">
                <span v-if="scope.row.status == 'Running'" class="icon-span-disabled el-icon-remove-outline"></span>
                <span v-else class="icon-span el-icon-caret-right" title="启动" @click="doStart(scope.row)"></span>
                <span v-if="scope.row.status == 'create'" class="icon-span-disabled el-icon-view"></span>
                <span v-else class="icon-span el-icon-view" title="查看" @click="doView(scope.row)"></span>
                <span v-if="scope.row.status == 'Running'" class="icon-span-disabled el-icon-delete"></span>
                <span v-else class="icon-span el-icon-delete" title="删除" @click="doDelete(scope.row)"></span>
            </template>
        </el-table-column>
    </el-table>
    <el-footer>
        <div class="enc-pagination">
            <el-pagination  style="float:right; margin:10px;"
            @current-change="handleCurrentChange"
            background
            :current-page.sync="pageNum"
            :page-size="pageSize"
            :total="totalPage"
            layout="prev, pager, next, jumper">
            </el-pagination>
        </div>
    </el-footer>
</div>
</template>
<script>
const baseUrl = 'http://10.19.160.67:8081/DOMN';
export default {
    data(){
        return {
            loading:false,
            pageNum: 1,
            pageSize: 10,
            totalPage: 0,
            status:[],
            checkStatus:[{name:'暂停',label:'Paused'},{name:'新建',label:'create'},{name:'失败',label:'Finished (with errors)'},{name:'运行',label:'Running'},{name:'完成',label:'Finished'}],
            isIndeterminate:true,
            checkAll:false,
            startTime: '',
            endTime: '',
            taskName:'',
            tableData:[],
            moreSearch:false,
            time: [],
            pickerOptions: {
                disabledDate(time) {
                return time.getTime() > Date.now();
                }
            }
            
        }
    },
    created(){
        this.init();
    },
    computed:{
        tableHeight() {
            return  !this.moreSearch?   window.innerHeight - 220:window.innerHeight - 335;
        },
        _checkStatus(){
            return this.checkStatus.map(item => item.label);
        },
    },
    methods: {
        handleCheckAllChange(val){
            this.status = val ? this._checkStatus : [];
            this.isIndeterminate = false;
        },
        handleCheckedCitiesChange(value){
            let checkedCount = value.length;
            this.checkAll = checkedCount === this.checkStatus.length;

            this.isIndeterminate = checkedCount > 0 && checkedCount < this.checkStatus.length;
            console.log(this.status)
        },
        handleCurrentChange() {
            this.init();
        },
        init(){
            let that = this;
            this.loading = true;
            this.$ajax.get(baseUrl+'/manager/govern/queryGovern',{
                params:{
                    pageNum:this.pageNum,
                    pageSize:this.pageSize,
                    status:this.status.join(),
                    startTime:this.startTime,
                    endTime:this.endTime,
                    taskName:this.taskName
                }
            }).then(res => {
                res = res.data;
                this.loading = false;
                if(res.success){
                    that.pageNum = res.data.pageNum;
                    that.totalPage = res.data.total;
                    that.tableData = res.data.result;
                }else{
                     that.$message({
                        showClose: true,
                        message: res.message,
                        duration: 3500
                    });
                }
            });
        },
        //启动
        doStart(row){
            this.loading = true;
            this.$ajax.post(baseUrl+'/manager/govern/startGovern',{
                params:{
                    "jobPath": row.jobPath,
                    "jobName": row.taskName
                }
            }).then(res => {
               res = res.data;
               this.loading = false;
               if(res.success){
                   row.status = 'Running';
               }else{
                   row.status = 'Finished (with errors)';
               }
            });
        },
        //查看
        doView(){

        },
        //删除
        doDelete(row){
            let that = this;
            this.loading = true;
            this.$ajax.post(baseUrl+'/manager/govern/deleteGovern',{
                params:{
                    carteObjectId: row.carteObjectId,
                    jobName: row.taskName,
                    jobPath: row.jobPath
                }
            }).then(res => {
                res = res.data;
                this.loading = false;
               if(res.success){
                   that.init();
               }else{
                    that.$alert(res.message,'删除');
               }
            });
        },
        //查询按钮
        search(){
            this.init();
        },
        //高级搜索
        doMoreSearch(){
            this.moreSearch=!this.moreSearch;
            this.status=[];
        },
    },
    filters:{
        formatDateTime(val){
            if(!val) return "";
            var value=new Date(val);
            var year=value.getFullYear();
            var padDate=function(va){
                va=va<10?'0'+va:va;
                return va
            }
            var month=padDate(value.getMonth()+1);
            var day=padDate(value.getDate());
            var hour=padDate(value.getHours());
            var minutes=padDate(value.getMinutes());
            var seconds=padDate(value.getSeconds());
            return year+'-'+month+'-'+day+' '+hour+':'+minutes+':'+seconds;
        },
    },
};
</script>
<style  lang="scss" scoped>
.dataSearch {
  display: inline-block;
  width: 210px;
  height: 30px;
  border: 1px solid #c9cdd0;
  input {
    margin-left: 5px;
    width: 180px;
    background-color: transparent;
    border: 0 none;
    outline: 0 none;
    height: 28px;
    font-size: 14px;
  }
  i{
    text-indent: 5px;
  }
  ::-webkit-input-placeholder {
    color: #999;
  } ///* 使用webkit内核的浏览器 */
  :-moz-placeholder {
    color: #999;
  } ///* Firefox版本4-18 */
  ::-moz-placeholder {
    color: #999;
  } ///* Firefox版本19+ */
  :-ms-input-placeholder {
    color: #999;
  } ///* IE浏览器 */
}
.searchDiv {
    margin-left: 10px;
    margin-bottom: 20px;
    span {
        display: inline-block;
        font-size: 14px;
        cursor: pointer;
        width: 100px;
        height: 30px;
        border: 1px solid #c9cdd0;
        border-left: none;
        line-height: 30px;
        text-align: center;
        position: relative;
        top: 1px;
    }
}
.doCearch{
    display: inline-block;
    height: 28px;
    margin-left: 15px;
    margin-top: 0;
    position: relative;
    top: 2px;
    line-height: 10px;
}
.el-checkbox-group{
    display:inline-block;
    margin-left:30px;
}
.icon-span{
    font-size:18px;
    color:#0095e7;
    cursor:pointer;
    margin-right:5px;
}
.icon-span-disabled{
    font-size:18px;
    color:#ccc;
    cursor: not-allowed;
    margin-right:5px;
}
.finished-fail{
    color:red;
}
</style>
<style>
.search-btn.el-button:focus, .search-btn.el-button:hover {
    color: #FFF;
    border-color: #85ce61;
    background-color: #85ce61;
}
</style>
